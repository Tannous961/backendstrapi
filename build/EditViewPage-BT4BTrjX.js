import{bx as ue,j as e,cG as pe,k as _,$ as k,F as E,T as x,H as y,bG as B,d2 as z,cz as ge,cA as me,fG as he,d as F,el as v,fH as fe,bp as q,ca as ye,fI as xe,aP as Te,by as Ae,aQ as D,aR as G,fJ as ke,d5 as Ee,fK as be,d6 as Ie,bS as je,aL as J,P as M,w as Se,aA as Ce,f as m,p as Pe,bv as _e,z as ve,aw as Re,v as Oe,V as Le,be as Me,bf as we,B as Ne,aT as K}from"./strapi-C-eRo5uk.js";import{b as $e,c as Ue,d as De}from"./apiTokens-DxSWP1TZ.js";import{A as P}from"./constants-Q2dfXdfa.js";import{a as Ge,b as Be,L as Fe,c as He,F as Ve,U as qe,T as Ke}from"./TokenTypeSelect-CKHUB23K.js";import{_ as Qe}from"./_baseMap-UJwXX86S.js";import"./transferTokens-IALTLe3f.js";import"./index-DG6N3l20.js";import"./index-BRVyLNfZ.js";import"./_baseEach-C6jXJlJS.js";const We=ue.injectEndpoints({endpoints:s=>({getPermissions:s.query({query:()=>"/admin/content-api/permissions",transformResponse:t=>t.data}),getRoutes:s.query({query:()=>"/admin/content-api/routes",transformResponse:t=>t.data})}),overrideExisting:!1}),{useGetPermissionsQuery:Ye,useGetRoutesQuery:ze}=We,[Je,Xe]=pe("ApiTokenPermissionsContext"),Ze=({children:s,...t})=>e.jsx(Je,{...t,children:s}),H=()=>Xe("useApiTokenPermissions"),es=({errors:s={},onChange:t,canEditInputs:n,isCreating:i,values:a={},apiToken:u={},onDispatch:c,setHasChangedPermissions:h})=>{const{formatMessage:o}=_(),p=({target:{value:l}})=>{h(!1),l==="full-access"&&c({type:"SELECT_ALL_ACTIONS"}),l==="read-only"&&c({type:"ON_CHANGE_READ_ONLY"})},b=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return e.jsx(k,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:e.jsxs(E,{direction:"column",alignItems:"stretch",gap:4,children:[e.jsx(x,{variant:"delta",tag:"h2",children:o({id:"global.details",defaultMessage:"Details"})}),e.jsxs(y.Root,{gap:5,children:[e.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Ge,{error:s.name,value:a.name,canEditInputs:n,onChange:t})},"name"),e.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Be,{error:s.description,value:a.description,canEditInputs:n,onChange:t})},"description"),e.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Fe,{isCreating:i,error:s.lifespan,value:a.lifespan,onChange:t,token:u})},"lifespan"),e.jsx(y.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(He,{value:a.type,error:s.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:l=>{p({target:{value:l}}),t({target:{name:"type",value:l}})},options:b,canEditInputs:n})},"type")]})]})})};var ss=z,ts=ge,ns=Qe,as=me;function is(s,t){var n=as(s)?ss:ns;return n(s,ts(t))}var rs=is;const os=B(rs);var cs=he;function ls(s){var t=s==null?0:s.length;return t?cs(s,1,t):[]}var ds=ls;const us=B(ds),ps=s=>{switch(s){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},gs=F(k)`
  margin: -1px;
  border-radius: ${({theme:s})=>s.spaces[1]} 0 0 ${({theme:s})=>s.spaces[1]};
`,ms=({route:s={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:t}=_(),{method:n,handler:i,path:a}=s,u=a?us(a.split("/")):[],[c="",h=""]=i?i.split("."):[],o=ps(s.method);return e.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsxs(x,{variant:"delta",tag:"h3",children:[t({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"Â ",e.jsx("span",{children:c}),e.jsxs(x,{variant:"delta",textColor:"primary600",children:[".",h]})]}),e.jsxs(E,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[e.jsx(gs,{background:o.background,borderColor:o.border,padding:2,children:e.jsx(x,{fontWeight:"bold",textColor:o.text,children:n})}),e.jsx(k,{paddingLeft:2,paddingRight:2,children:os(u,p=>e.jsxs(x,{textColor:p.includes(":")?"neutral600":"neutral900",children:["/",p]},p))})]})]})},hs=()=>{const{value:{selectedAction:s,routes:t}}=H(),{formatMessage:n}=_(),i=s?.split(".")[0];return e.jsx(y.Item,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},direction:"column",alignItems:"stretch",children:s?e.jsx(E,{direction:"column",alignItems:"stretch",gap:2,children:i&&i in t&&t[i].map(a=>a.config.auth?.scope?.includes(s)||a.handler===s?e.jsx(ms,{route:a},a.handler):null)}):e.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(x,{variant:"delta",tag:"h3",children:n({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),e.jsx(x,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},Q=xe`
  background: ${s=>s.theme.colors.primary100};

  #cog {
    opacity: 1;
  }
`,fs=F(k)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  #cog {
    opacity: 0;
    path {
      fill: ${s=>s.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${s=>s.$isActive&&Q}
  &:hover {
    ${Q}
  }
`,ys=F.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:s})=>s.colors.neutral150};
`,xs=({controllers:s=[],label:t,orderNumber:n=0,disabled:i=!1})=>{const{value:{onChangeSelectAll:a,onChange:u,selectedActions:c,setSelectedAction:h,selectedAction:o}}=H(),{formatMessage:p}=_(),b=l=>l===o;return e.jsxs(v.Item,{value:`${t}-${n}`,children:[e.jsx(v.Header,{variant:n%2?"primary":"secondary",children:e.jsx(v.Trigger,{children:fe(t)})}),e.jsx(v.Content,{children:s?.map(l=>{const R=l.actions.every(g=>c.includes(g.actionId)),w=l.actions.some(g=>c.includes(g.actionId));return e.jsxs(k,{children:[e.jsxs(E,{justifyContent:"space-between",alignItems:"center",padding:4,children:[e.jsx(k,{paddingRight:4,children:e.jsx(x,{variant:"sigma",textColor:"neutral600",children:l?.controller})}),e.jsx(ys,{}),e.jsx(k,{paddingLeft:4,children:e.jsx(q,{checked:!R&&w?"indeterminate":R,onCheckedChange:()=>{a({target:{value:[...l.actions]}})},disabled:i,children:p({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),e.jsx(y.Root,{gap:4,padding:4,children:l?.actions&&l?.actions.map(g=>e.jsx(y.Item,{col:6,direction:"column",alignItems:"stretch",children:e.jsxs(fs,{$isActive:b(g.actionId),padding:2,hasRadius:!0,children:[e.jsx(q,{checked:c.includes(g.actionId),name:g.actionId,onCheckedChange:()=>{u({target:{value:g.actionId}})},disabled:i,children:e.jsx("span",{style:{overflowWrap:"anywhere"},children:g.action})}),e.jsx("button",{type:"button","data-testid":"action-cog",onClick:()=>h({target:{value:g.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:e.jsx(ye,{id:"cog"})})]})},g.actionId))})]},`${t}.${l?.controller}`)})})]})},Ts=({section:s=null,...t})=>e.jsx(k,{children:e.jsx(v.Root,{size:"M",children:s&&s.map((n,i)=>e.jsx(xs,{label:n.label,controllers:n.controllers,orderNumber:i,...t},n.apiId))})}),As=({...s})=>{const{value:{data:t}}=H(),{formatMessage:n}=_();return e.jsxs(y.Root,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[e.jsxs(y.Item,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,direction:"column",alignItems:"stretch",gap:6,children:[e.jsxs(E,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(x,{variant:"delta",tag:"h2",children:n({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),e.jsx(x,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),t?.permissions&&e.jsx(Ts,{section:t?.permissions,...s})]}),e.jsx(hs,{})]})},ks=Te().shape({name:D().max(100).required(G.required.id),type:D().oneOf(["read-only","full-access","custom"]).required(G.required.id),description:D().nullable(),lifespan:Ae().integer().min(0).nullable().defined(G.required.id)});function Es(s,t,n,i){for(var a=n-1,u=s.length;++a<u;)if(i(s[a],t))return a;return-1}var bs=Es,Is=z,js=be,Ss=bs,Cs=Ee,Ps=ke,_s=Array.prototype,W=_s.splice;function vs(s,t,n,i){var a=i?Ss:js,u=-1,c=t.length,h=s;for(s===t&&(t=Ps(t)),n&&(h=Is(s,Cs(n)));++u<c;)for(var o=0,p=t[u],b=n?n(p):p;(o=a(h,b,o,i))>-1;)h!==s&&W.call(h,o,1),W.call(s,o,1);return s}var Rs=vs,Os=Rs;function Ls(s,t){return s&&s.length&&t&&t.length?Os(s,t):s}var Ms=Ls,ws=Ie,Ns=Ms,$s=ws(Ns),Us=$s;const Y=B(Us),Ds=s=>{const t={allActionsIds:[],permissions:[]};return t.permissions=Object.entries(s).map(([n,i])=>({apiId:n,label:n.split("::")[1],controllers:Object.keys(i.controllers).map(a=>({controller:a,actions:a in i.controllers?i.controllers[a].map(u=>{const c=`${n}.${a}.${u}`;return n.includes("api::")&&t.allActionsIds.push(c),{action:u,actionId:c}}).flat():[]})).flat()})),t},Gs={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},Bs=(s,t)=>je(s,n=>{switch(t.type){case"ON_CHANGE":{n.selectedActions.includes(t.value)?Y(n.selectedActions,t.value):n.selectedActions.push(t.value);break}case"SELECT_ALL_IN_PERMISSION":{t.value.every(a=>n.selectedActions.includes(a.actionId))?t.value.forEach(a=>{Y(n.selectedActions,a.actionId)}):t.value.forEach(a=>{n.selectedActions.push(a.actionId)});break}case"SELECT_ALL_ACTIONS":{n.selectedActions=[...n.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const i=n.data.allActionsIds.filter(a=>a.includes("find")||a.includes("findOne"));n.selectedActions=[...i];break}case"UPDATE_PERMISSIONS_LAYOUT":{n.data=Ds(t.value);break}case"UPDATE_ROUTES":{n.routes={...t.value};break}case"UPDATE_PERMISSIONS":{n.selectedActions=[...t.value];break}case"SET_SELECTED_ACTION":{n.selectedAction=t.value;break}default:return n}}),Fs=()=>{const{formatMessage:s}=_(),{toggleNotification:t}=Se(),{state:n}=Ce(),i=J(r=>r.admin_app.permissions),[a,u]=m.useState(n?.apiToken?.accessKey?{...n.apiToken}:null),[c,h]=m.useState(!!n?.apiToken?.accessKey),o=m.useRef(null),{trackUsage:p}=Pe(),b=_e("EditView",r=>r.setCurrentStep),{allowedActions:{canCreate:l,canUpdate:R,canRegenerate:w}}=ve(i.settings?.["api-tokens"]),[g,f]=m.useReducer(Bs,Gs),O=Re("/settings/api-tokens/:id")?.params?.id,T=O==="create",{_unstableFormatAPIError:A,_unstableFormatValidationErrors:V}=Oe(),X=Le(),j=Ye(),S=ze();m.useEffect(()=>{j.error&&t({type:"danger",message:A(j.error)})},[j.error,A,t]),m.useEffect(()=>{S.error&&t({type:"danger",message:A(S.error)})},[S.error,A,t]),m.useEffect(()=>{j.data&&f({type:"UPDATE_PERMISSIONS_LAYOUT",value:j.data})},[j.data]),m.useEffect(()=>{S.data&&f({type:"UPDATE_ROUTES",value:S.data})},[S.data]),m.useEffect(()=>{a&&(a.type==="read-only"&&f({type:"ON_CHANGE_READ_ONLY"}),a.type==="full-access"&&f({type:"SELECT_ALL_ACTIONS"}),a.type==="custom"&&f({type:"UPDATE_PERMISSIONS",value:a?.permissions}))},[a]),m.useEffect(()=>{p(T?"didAddTokenFromList":"didEditTokenFromList",{tokenType:P})},[T,p]);const{data:I,error:N,isLoading:Z}=$e(O,{skip:!O||T||!!a});m.useEffect(()=>{N&&t({type:"danger",message:A(N)})},[N,A,t]),m.useEffect(()=>{I&&(u(I),I.type==="read-only"&&f({type:"ON_CHANGE_READ_ONLY"}),I.type==="full-access"&&f({type:"SELECT_ALL_ACTIONS"}),I.type==="custom"&&f({type:"UPDATE_PERMISSIONS",value:I?.permissions}))},[I]),m.useEffect(()=>{if(c)return o.current=setTimeout(()=>{h(!1)},3e4),()=>{o.current&&(clearTimeout(o.current),o.current=null)}},[c]);const[ee]=Ue(),[se]=De(),te=async(r,C)=>{p(T?"willCreateToken":"willEditToken",{tokenType:P});try{if(T){const d=await ee({...r,lifespan:r?.lifespan&&r.lifespan!=="0"?parseInt(r.lifespan.toString(),10):null,permissions:r.type==="custom"?g.selectedActions:null});if("error"in d){K(d.error)&&d.error.name==="ValidationError"?C.setErrors(V(d.error)):t({type:"danger",message:A(d.error)});return}t({type:"success",message:s({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),p("didCreateToken",{type:d.data.type,tokenType:P}),X(`../api-tokens/${d.data.id.toString()}`,{state:{apiToken:d.data},replace:!0}),b("apiTokens.success")}else{const d=await se({id:O,name:r.name,description:r.description,type:r.type,permissions:r.type==="custom"?g.selectedActions:null});if("error"in d){K(d.error)&&d.error.name==="ValidationError"?C.setErrors(V(d.error)):t({type:"danger",message:A(d.error)});return}t({type:"success",message:s({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),p("didEditToken",{type:d.data.type,tokenType:P})}}catch{t({type:"danger",message:s({id:"notification.error",defaultMessage:"Something went wrong"})})}},[ne,$]=m.useState(!1),ae=({target:{value:r}})=>{$(!0),f({type:"ON_CHANGE",value:r})},ie=({target:{value:r}})=>{$(!0),f({type:"SELECT_ALL_IN_PERMISSION",value:r})},re=({target:{value:r}})=>{f({type:"SET_SELECTED_ACTION",value:r})},oe=()=>{h(r=>!r),o.current&&(clearTimeout(o.current),o.current=null)},ce={...g,onChange:ae,onChangeSelectAll:ie,setSelectedAction:re},U=R&&!T||l&&T,le=!!a?.accessKey;return Z?e.jsx(M.Loading,{}):e.jsx(Ze,{value:ce,children:e.jsxs(M.Main,{children:[e.jsx(M.Title,{children:s({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:"API Tokens"})}),e.jsx(Me,{validationSchema:ks,validateOnChange:!1,initialValues:{name:a?.name||"",description:a?.description||"",type:a?.type,lifespan:a?.lifespan},enableReinitialize:!0,onSubmit:(r,C)=>te(r,C),children:({errors:r,handleChange:C,isSubmitting:d,values:L,setFieldValue:de})=>(ne&&L?.type!=="custom"&&de("type","custom"),e.jsxs(we,{children:[e.jsx(Ve,{title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:a,setToken:u,toggleToken:oe,showToken:c,canEditInputs:U,canRegenerate:w,canShowToken:le,isSubmitting:d,regenerateUrl:"/admin/api-tokens/"}),e.jsx(Ne.Content,{children:e.jsxs(E,{direction:"column",alignItems:"stretch",gap:6,children:[a?.accessKey&&c&&e.jsx(e.Fragment,{children:window.strapi.future.isEnabled("unstableGuidedTour")?e.jsx(qe,{token:a.accessKey,tokenType:P}):e.jsx(Ke,{token:a.accessKey,tokenType:P})}),e.jsx(es,{errors:r,onChange:C,canEditInputs:U,isCreating:T,values:L,apiToken:a,onDispatch:f,setHasChangedPermissions:$}),e.jsx(As,{disabled:!U||L?.type==="read-only"||L?.type==="full-access"})]})})]}))})]})})},Zs=()=>{const s=J(t=>t.admin_app.permissions.settings?.["api-tokens"].read);return e.jsx(M.Protect,{permissions:s,children:e.jsx(Fs,{})})};export{Fs as EditView,Zs as ProtectedEditView};
